---
output:
  html_document:
    self_contained: false
    lib_dir: "../site/document/libs"
    includes:
      before_body: "../site/navbar.html"
params:
  document: "Journal de Guienne"
  document_subtitle: "Wednesday, September 01, 1784"
  document_id: 1
title: "`r params$document`"
subtitle: "`r params$document_subtitle`"


---

```{r setup, include=FALSE}
library(tidyverse)
library(DT)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)

documents <- read_csv("../data/processed/db_tables/document.csv")
venues <- read_csv("../data/processed/db_tables/venue.csv")
performances <- read_csv("../data/processed/db_tables/performance.csv", col_types = "cncccccccD")
works <- read_csv("../data/processed/db_tables/work.csv")
genres <- read_csv("../data/processed/db_tables/genre.csv")
persons <- read_csv("../data/processed/db_tables/person.csv")
document_has_venue <- read_csv("../data/processed/db_tables/document_has_venue.csv")
document_has_performance <- read_csv("../data/processed/db_tables/document_has_performance.csv")
performance_has_work <- read_csv("../data/processed/db_tables/performance_has_work.csv")
person_has_performance <- read_csv("../data/processed/db_tables/person_has_performance.csv")
work_has_person <- read_csv("../data/processed/db_tables/work_has_person.csv")
work_has_genre <- read_csv("../data/processed/db_tables/work_has_genre.csv")

```

```{r}
doc_info <- documents %>%
  filter(doc_id == params$document_id)
```

# Original Document
[`r doc_info$title[1]`](`r doc_info$links[1]`)

# Performances
```{r}
perf <- doc_info %>%
  left_join(document_has_performance) %>%
  left_join(performances) %>%
  left_join(performance_has_work) %>%
  left_join(works) %>%
  left_join(venues) %>%
  mutate(
    perf_link = ifelse(!is.na(performance_id), paste0("<a href='../performance/", performance_id, ".html'>Performance</a>"), ""),
    work_link = ifelse(!is.na(work_id), paste0("<a href='../work/", work_id, ".html'>", str_to_title(work), "</a>"), ""),
    venue_link = ifelse(!is.na(venue_id), paste0("<a href='../venue/", venue_id, ".html'>", str_to_title(venue), "</a>"), "")
  ) %>%
  select(
    Date = date,
    Venue = venue_link,
    `Link to Performance` = perf_link,
    Work = work_link
  )

datatable(perf, escape = FALSE)
```

# People
```{r}
people <- doc_info %>%
  left_join(document_has_performance) %>%
  left_join(performances) %>%
  left_join(person_has_performance) %>%
  left_join(persons) %>%
  left_join(works) %>%
  filter(!is.na(person_id)) %>%
  mutate(
    person_link = ifelse(!is.na(person_id), paste0("<a href='../person/", person_id, ".html'>", person, "</a>"), ""),
    perf_link = ifelse(!is.na(performance_id), paste0("<a href='../performance/", performance_id, ".html'>Performance</a>"), ""),
    work_link = ifelse(!is.na(work_id), paste0("<a href='../work/", work_id, ".html'>", str_to_title(work), "</a>"), "")
  ) %>%
  select(
    `Link to Performance` = perf_link,
    Person = person_link,
    Work = work_link,
    Role = role,
    Character = char_role
  ) %>%
  mutate(Character = ifelse(is.na(Character), "", Character),
         Role = str_to_title(Role))

datatable(people, escape = FALSE)
```
