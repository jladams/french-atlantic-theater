---
output:
  html_document:
    self_contained: false
    lib_dir: "../site/work/libs"
params:
  work: "ariettes Anglaises"
  work_id: 176
title: "`r params$work`"
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(DT)
library(plotly)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)

documents <- read_csv("../data/processed/db_tables/document.csv")
venues <- read_csv("../data/processed/db_tables/venue.csv")
performances <- read_csv("../data/processed/db_tables/performance.csv", col_types = "cncccccccD")
works <- read_csv("../data/processed/db_tables/work.csv")
genres <- read_csv("../data/processed/db_tables/genre.csv")
persons <- read_csv("../data/processed/db_tables/person.csv")
document_has_venue <- read_csv("../data/processed/db_tables/document_has_venue.csv")
document_has_performance <- read_csv("../data/processed/db_tables/document_has_performance.csv")
performance_has_work <- read_csv("../data/processed/db_tables/performance_has_work.csv")
person_has_performance <- read_csv("../data/processed/db_tables/person_has_performance.csv")
work_has_person <- read_csv("../data/processed/db_tables/work_has_person.csv")
work_has_genre <- read_csv("../data/processed/db_tables/work_has_genre.csv")

```

# People
```{r}
works %>%
  filter(work_id == params$work_id) %>%
  left_join(work_has_person) %>%
  left_join(persons) %>%
  left_join(person_has_performance) %>%
  left_join(performances) %>%
  mutate(
    person_link = ifelse(!is.na(person_id), paste0("<a href='../person/", person_id, ".html'>", person, "</a>"), ""),
    perf_link = ifelse(!is.na(performance_id), paste0("<a href='../performance/", performance_id, ".html'>Performance</a>"), ""),
    role = str_to_title(role)
  ) %>%
  select(
    Date = date,
    Person = person_link,
    Role = role,
    `Link to Performance` = perf_link
  ) %>%
  datatable(escape = FALSE)
```

# Performances Over Time
```{r}
perf <- works %>%
  filter(work_id == params$work_id) %>%
  left_join(performance_has_work) %>%
  left_join(performances) %>%
  distinct(date, performance_id) %>%
  mutate(date = floor_date(date, "months")) %>%
  group_by(date) %>%
  tally() %>%
  mutate(label = paste0(format(date, "%b %Y"), ": ", n)) %>%
  filter(!is.na(date))

if(nrow(perf) > 0) {
  p <- ggplot(perf, aes(x = date, y = n)) + 
    geom_line() +
    geom_point(aes(text = label)) +
    theme_minimal() +
    labs(
      title = "Monthly Performances",
      x = "",
      y = ""
    ) 
  
  plotly::ggplotly(p = p, tooltip = "text")
}

```

# Genres
```{r}
genre <- works %>%
  filter(work_id == params$work_id) %>%
  left_join(work_has_genre) %>%
  left_join(genres) %>%
  filter(!is.na(genre))
```

```{r results='asis'}
if(nrow(genre) > 0) {
  for(i in 1:nrow(genre)) {
    cat(paste0("- [", genre$genre[i], "](../genre/", genre$genre_id[i], ".html)"), sep = "\n")  
  }
}

```